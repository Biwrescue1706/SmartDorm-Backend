generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Admin {
  adminId   String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomsCreated Room[] @relation("RoomCreatedBy")
  roomsUpdated Room[] @relation("RoomUpdatedBy")
  billsCreated Bill[] @relation("BillCreatedBy")
  billsUpdated Bill[] @relation("BillUpdatedBy")
}

model Room {
  roomId     String   @id @default(auto()) @map("_id") @db.ObjectId
  number     String   @unique
  size       String
  rent       Int
  deposit    Int
  bookingFee Int
  status     Int // 0 = ว่าง, 1 = ไม่ว่าง
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  createdBy String  @db.ObjectId
  updatedBy String? @db.ObjectId

  adminCreated Admin? @relation("RoomCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin? @relation("RoomUpdatedBy", fields: [updatedBy], references: [adminId])

  bookings Booking[]
  bills    Bill[]
}

model Customer {
  customerId String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @unique // LINE LIFF userId (1 User = 1 record)
  userName   String
  ctitle     String
  cname      String
  csurname   String
  fullName   String
  cphone     String
  cmumId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  bookings Booking[]
  bills    Bill[]
}

model Bill {
  billId    String   @id @default(auto()) @map("_id") @db.ObjectId
  number    String   @unique
  month     DateTime
  rent      Int
  service   Int
  wBefore   Int
  wAfter    Int
  wUnits    Int
  wPrice    Int
  eBefore   Int
  eAfter    Int
  eUnits    Int
  ePrice    Int
  fine      Int
  total     Int
  slipUrl   String
  status    Int      @default(0) // 0=ยังไม่ชำระ, 1=ชำระแล้ว, 2=รอตรวจสอบ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // FK -> Room
  roomId String @db.ObjectId
  room   Room   @relation(fields: [roomId], references: [roomId])

  // FK -> Customer
  customerId String   @db.ObjectId
  customer   Customer @relation(fields: [customerId], references: [customerId])

  // FK -> Admin
  createdBy    String  @db.ObjectId
  updatedBy    String? @db.ObjectId
  adminCreated Admin?  @relation("BillCreatedBy", fields: [createdBy], references: [adminId])
  adminUpdated Admin?  @relation("BillUpdatedBy", fields: [updatedBy], references: [adminId])

  // 1 Bill = 1 Payment
  payment Payment?
}

model Booking {
  bookingId    String    @id @default(auto()) @map("_id") @db.ObjectId
  roomId       String    @db.ObjectId
  customerId   String    @db.ObjectId
  checkin      DateTime
  status       Int
  createdAt    DateTime  @default(now())
  checkout     DateTime?
  returnStatus Int?      @default(0)
  updatedAt    DateTime  @updatedAt

  // FK relations
  room     Room     @relation(fields: [roomId], references: [roomId])
  customer Customer @relation(fields: [customerId], references: [customerId])
  payment  Payment? // ✅ Prisma จะ map ไปที่ bookingId ฝั่ง Payment ให้เอง
}

model Payment {
  paymentId String   @id @default(auto()) @map("_id") @db.ObjectId
  billId    String?  @unique @db.ObjectId
  bookingId String?  @unique @db.ObjectId
  slipUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking Booking? @relation(fields: [bookingId], references: [bookingId])
  bill    Bill?     @relation(fields: [billId], references: [billId])
}
