import { Router, Request, Response } from "express";
import prisma from "../prisma";

const router = Router();

// üìù ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Customer ‡∏ú‡πà‡∏≤‡∏ô LINE LIFF
router.post("/register", async (req: Request, res: Response) => {
  try {
    const { userId, ctitle, userName, cmumId, cname, csurname, cphone } =
      req.body;

    if (!userId || !ctitle || !userName || !cname || !cphone) {
      return res.status(400).json({ error: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö" });
    }

    let customer = await prisma.customer.findUnique({ where: { userId } });

    if (customer) {
      customer = await prisma.customer.update({
        where: { customerId: customer.customerId },
        data: {
          userName,
          cmumId,
          ctitle,
          cname,
          csurname,
          cphone,
          fullName: `${ctitle}${cname} ${csurname}`,
        },
      });
    } else {
      customer = await prisma.customer.create({
        data: {
          userId,
          userName,
          ctitle,
          cmumId,
          cname,
          csurname,
          cphone,
          fullName: `${ctitle}${cname} ${csurname}`,
        },
      });
    }

    res.json({ message: "‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Customer ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", customer });
  } catch (err) {
    console.error("‚ùå Error register customer:", err);
    res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Customer ‡πÑ‡∏î‡πâ" });
  }
});

// üìå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Customer + Bookings + Bills
router.get("/:userId", async (req: Request, res: Response) => {
  try {
    const { userId } = req.params;

    const customer = await prisma.customer.findUnique({
      where: { userId },
      include: {
        bookings: { include: { room: true } }, // ‚ùå booking ‡πÑ‡∏°‡πà‡∏°‡∏µ payment
        bills: { include: { room: true, payment: true } }, // ‚úÖ bill ‡∏°‡∏µ payment
      },
    });

    if (!customer) return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Customer" });

    res.json(customer);
  } catch (err) {
    console.error("‚ùå Error fetching customer:", err);
    res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Customer ‡πÑ‡∏î‡πâ" });
  }
});

// üí∞ ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á Customer
router.get("/:userId/payments", async (req: Request, res: Response) => {
  try {
    const { userId } = req.params;

    const customer = await prisma.customer.findUnique({
      where: { userId },
      include: {
        bills: { include: { payment: true, room: true } }, // ‚úÖ bill ‡∏°‡∏µ payment
        bookings: { include: { room: true } }, // ‚ùå booking ‡πÑ‡∏°‡πà‡∏°‡∏µ payment
      },
    });

    if (!customer) return res.status(404).json({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Customer" });

    const payments = [
      ...customer.bills
        .filter((b) => b.payment)
        .map((b) => ({
          type: "bill" as const,
          billNumber: b.number,
          roomNumber: b.room.number,
          amount: b.total,
          slipUrl: b.payment?.slipUrl,
          createdAt: b.payment?.createdAt,
        })),
      // üëâ booking ‡πÑ‡∏°‡πà‡∏°‡∏µ payment ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ slip ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ booking.slipUrl ‡πÅ‡∏ó‡∏ô
      ...customer.bookings.map((bk) => ({
        type: "booking" as const,
        bookingId: bk.bookingId,
        roomNumber: bk.room.number,
        amount: bk.room.rent + bk.room.deposit + bk.room.bookingFee,
        slipUrl: bk.slipUrl, // ‚úÖ booking ‡πÉ‡∏ä‡πâ slipUrl ‡∏à‡∏≤‡∏Å model ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        createdAt: bk.createdAt,
      })),
    ].sort((a, b) => b.createdAt!.getTime() - a.createdAt!.getTime());

    res.json({ userId: customer.userId, payments });
  } catch (err) {
    console.error("‚ùå Error fetching payments:", err);
    res.status(500).json({ error: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ" });
  }
});

export default router;
